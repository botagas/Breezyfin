name: Release Develop

on:
  push:
    branches:
      - develop
  workflow_dispatch:

permissions:
  contents: write

jobs:
  prerelease:
    if: github.ref_name == 'develop'
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install build CLIs
        run: npm install --global @enact/cli @webos-tools/cli

      - name: Lint
        run: npm run lint

      - name: Run tests
        run: CI=true npm run test -- --watch=false --passWithNoTests

      - name: Build production bundle
        env:
          REACT_APP_ENABLE_STYLE_DEBUG: "1"
          REACT_APP_ENABLE_PERSISTENT_LOGS: "1"
        run: |
          npm run clean
          npm run pack-p

      - name: Prepare release metadata
        id: metadata
        run: |
          mkdir -p dist

          if [ ! -f dist/appinfo.json ]; then
            cp appinfo.json dist/appinfo.json
          fi

          if [ -f icon.png ] && [ ! -f dist/icon.png ]; then
            cp icon.png dist/icon.png
          fi

          python3 scripts/release/collect_metadata.py \
            --appinfo dist/appinfo.json \
            --package-json package.json \
            > /tmp/release-metadata.txt

          cat /tmp/release-metadata.txt >> "$GITHUB_OUTPUT"

      - name: Build IPK
        id: package
        run: |
          rm -rf build release
          mkdir -p build release

          ares-config --profile tv
          ares-package dist --outdir build

          IPK_PATH="$(find build -maxdepth 1 -name '*.ipk' | head -n 1)"
          if [ -z "${IPK_PATH}" ]; then
            echo "No IPK was generated."
            exit 1
          fi

          echo "ipk_path=${IPK_PATH}" >> "$GITHUB_OUTPUT"
          echo "ipk_name=$(basename "${IPK_PATH}")" >> "$GITHUB_OUTPUT"

      - name: Generate manifest
        id: manifest
        run: |
          MANIFEST_PATH="release/${{ steps.metadata.outputs.app_id }}.manifest.json"
          python3 scripts/release/generate_manifest.py \
            --appinfo dist/appinfo.json \
            --ipk "${{ steps.package.outputs.ipk_path }}" \
            --output "${MANIFEST_PATH}" \
            --ipk-url "${{ steps.package.outputs.ipk_name }}" \
            --icon-uri "https://raw.githubusercontent.com/${{ github.repository }}/develop/icon.png" \
            --source-url "https://github.com/${{ github.repository }}" \
            --app-description "${{ steps.metadata.outputs.description }}" \
            --root-required false

          echo "manifest_path=${MANIFEST_PATH}" >> "$GITHUB_OUTPUT"

      - name: Move nightly tag to current develop commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -fa nightly -m "Nightly prerelease"
          git push origin refs/tags/nightly --force

      - name: Publish prerelease assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          target_commitish: ${{ github.sha }}
          name: Breezyfin Nightly
          body: |
            Automated prerelease from `develop` (nightly channel).
            Commit: `${{ github.sha }}`
            Version: `${{ steps.metadata.outputs.version }}`
          prerelease: true
          make_latest: false
          overwrite_files: true
          fail_on_unmatched_files: true
          files: |
            ${{ steps.package.outputs.ipk_path }}
            ${{ steps.manifest.outputs.manifest_path }}
